import fs from 'fs';
import fetch from 'node-fetch';
import moment from 'moment-timezone';

let handler = m => m;

handler.all = async function (m) {
    let name = await conn.getName(m.sender);
    let pp = 'https://i0.wp.com/www.gambarunik.id/wp-content/uploads/2019/06/Top-Gambar-Foto-Profil-Kosong-Lucu-Tergokil-.jpg';

    try {
        pp = await this.profilePictureUrl(m.sender, 'image');
    } catch (e) {
        console.error('‚ö†Ô∏è No se pudo obtener la imagen de perfil del usuario. Usando imagen predeterminada.');
    } finally {
        // Configuraci√≥n de archivos globales
        global.doc = pickRandom([
            "application/vnd.ms-excel",
            "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            "application/msword",
            "application/pdf"
        ]);

        // Cargar m√≥dulos
        global.fetch = (await import('node-fetch')).default;
        global.bochil = await import('@bochilteam/scraper');
        global.fs = fs;

        // Tiempo de actividad del bot
        const _uptime = process.uptime() * 1000;

        // Saludo din√°mico seg√∫n la hora del d√≠a
        global.ucapan = ucapan();

        // Duraci√≥n de mensajes ef√≠meros
        global.ephemeral = '86400';

        // Configuraci√≥n de respuestas para mensajes autom√°ticos con tono amigable de Admin-TK
        global.rcanal = {
            contextInfo: {
                isForwarded: true,
                forwardedNewsletterMessageInfo: {
                    newsletterJid: global.idcanal,
                    serverMessageId: 100,
                    newsletterName: global.ucapan,
                },
                externalAdReply: {
                    showAdAttribution: true,
                    title: "Admin-TK ‚úß",
                    body: wm,
                    mediaUrl: "https://pomf2.lain.la/f/onvv8i5b.jpg",
                    description: null,
                    previewType: "PHOTO",
                    thumbnailUrl: "https://pomf2.lain.la/f/onvv8i5b.jpg",
                    thumbnail: fs.readFileSync('./media/reply_img.jpg'),
                    sourceUrl: sig,
                    mediaType: 1,
                    previewType: 0,
                    renderLargerThumbnail: false
                },
            },
        };

        global.adReply = {
            contextInfo: {
                isForwarded: true,
                forwardedNewsletterMessageInfo: {
                    newsletterJid: global.idcanal,
                    serverMessageId: 100,
                    newsletterName: global.ucapan,
                },
            },
        };

        global.sig = {
            contextInfo: {
                externalAdReply: {
                    showAdAttribution: true,
                    title: global.ucapan,
                    body: wm,
                    thumbnailUrl: pp,
                    sourceUrl: sig,
                },
            },
        };

        global.sfb = {
            contextInfo: {
                externalAdReply: {
                    showAdAttribution: true,
                    title: global.ucapan,
                    body: wm,
                    thumbnailUrl: pp,
                    sourceUrl: sfb,
                },
            },
        };

        // Mensajes falsos y respuestas autom√°ticas
        global.ftroli = {
            key: { remoteJid: 'status@broadcast', participant: '0@s.whatsapp.net' },
            message: {
                orderMessage: {
                    itemCount: 9999999999999999,
                    status: 1,
                    surface: 1,
                    message: wm,
                    orderTitle: wm,
                    sellerJid: '0@s.whatsapp.net'
                }
            }
        };

        global.fkontak = {
            key: { fromMe: false, participant: `0@s.whatsapp.net`, ...(m.chat ? { remoteJid: `status@broadcast` } : {}) },
            message: {
                'contactMessage': {
                    'displayName': wm,
                    'vcard': `BEGIN:VCARD\nVERSION:3.0\nN:XL;${wm},;;;\nFN:${wm},\nitem1.TEL;waid=${m.sender.split('@')[0]}:${m.sender.split('@')[0]}\nitem1.X-ABLabell:Ponsel\nEND:VCARD`,
                    'jpegThumbnail': fs.readFileSync('./thumbnail.jpg'),
                    sendEphemeral: true
                }
            }
        };

        global.fvn = {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`, ...(m.chat ? { remoteJid: "6282127487538-1625305606@g.us" } : {})
            },
            message: {
                "audioMessage": {
                    "mimetype": "audio/ogg; codecs=opus",
                    "seconds": "999999999",
                    "ptt": true
                }
            }
        };

        global.keni = {
            key: {
                remoteJid: '0@s.whatsapp.net',
                participant: '0@s.whatsapp.net'
            },
            message: {
                newsletterAdminInviteMessage: {
                    newsletterJid: '120363210705976689@newsletter',
                    newsletterName: '',
                    caption: `${wm} | 2022 - 2025`
                }
            }
        };

        global.ftextt = {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`, ...(m.chat ? { remoteJid: "6282127487538-1625305606@g.us" } : {})
            },
            message: {
                "extendedTextMessage": {
                    "text": wm,
                    "title": wm,
                    'jpegThumbnail': fs.readFileSync('./thumbnail.jpg')
                }
            }
        };

        global.fliveLoc = {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`, ...(m.chat ? { remoteJid: "status@broadcast" } : {})
            },
            message: {
                "liveLocationMessage": {
                    "caption": "by : Admin-TK ‚úß",
                    "h": `${wm}`,
                    'jpegThumbnail': fs.readFileSync('./thumbnail.jpg')
                }
            }
        };

        global.fliveLoc2 = {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`, ...(m.chat ? { remoteJid: "status@broadcast" } : {})
            },
            message: {
                "liveLocationMessage": {
                    "title": "Admin-TK ‚úß",
                    "h": wm,
                    'jpegThumbnail': fs.readFileSync('./thumbnail.jpg')
                }
            }
        };

        global.ftoko = {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`, ...(m.chat ? { remoteJid: "6282127487538@s.whatsapp.net" } : {})
            },
            message: {
                "productMessage": {
                    "product": {
                        "productImage": {
                            "mimetype": "image/jpeg",
                            "jpegThumbnail": fs.readFileSync('./thumbnail.jpg')
                        },
                        "title": wm,
                        "description": "Simple Bot Esm",
                        "currencyCode": "USD",
                        "priceAmount1000": "20000000",
                        "retailerId": "Ghost",
                        "productImageCount": 1
                    },
                    "businessOwnerJid": `0@s.whatsapp.net`
                }
            }
        };

        global.fdocs = {
            key: {
                participant: '0@s.whatsapp.net'
            },
            message: {
                documentMessage: {
                    title: wm,
                    jpegThumbnail: fs.readFileSync('./thumbnail.jpg')
                }
            }
        };

        global.fgclink = {
            key: {
                fromMe: false,
                participant: "0@s.whatsapp.net",
                remoteJid: "0@s.whatsapp.net"
            },
            message: {
                "groupInviteMessage": {
                    "groupJid": "6282127487538-1625305606@g.us",
                    "inviteCode": "null",
                    "groupName": "Kawan Admin-TK ‚úß",
                    "caption": wm,
                    'jpegThumbnail': fs.readFileSync('./thumbnail.jpg')
                }
            }
        };

        global.fgif = {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`, ...(m.chat ? { remoteJid: "6282127487538-1625305606@g.us" } : {})
            },
            message: {
                "videoMessage": {
                    "title": wm,
                    "h": `Hmm`,
                    'seconds': '999999999',
                    'gifPlayback': true,
                    'caption': wm,
                    'jpegThumbnail': fs.readFileSync('./thumbnail.jpg')
                }
            }
        };
    }
};

export default handler;

// Funci√≥n para generar un saludo espec√≠fico seg√∫n la hora del d√≠a en Lima, Per√∫ (formato 24 horas)
function ucapan() {
    const time = moment.tz('America/Lima').format('HH');
    let res;

    switch (parseInt(time)) {
        case 0:
            res = "üåô Medianoche, espero que descanses bien. üåô";
            break;
        case 1:
            res = "üåô Es muy tarde, recuerda descansar bien. üåô";
            break;
        case 2:
            res = "üåô Deber√≠as dormir para tener un buen d√≠a ma√±ana. üåô";
            break;
        case 3:
            res = "üåô Que tengas dulces sue√±os. üåô";
            break;
        case 4:
            res = "üåô ¬°Muy temprano! Espero que est√©s descansando. üåô";
            break;
        case 5:
            res = "üåÑ ¬°Buena madrugada! Espero que est√©s bien. üåÑ";
            break;
        case 6:
            res = "üåÑ Buenos d√≠as, que tengas una excelente ma√±ana. üåÑ";
            break;
        case 7:
            res = "‚òÄÔ∏è ¬°Buenos d√≠as! Ya empieza el d√≠a con energ√≠a. ‚òÄÔ∏è";
            break;
        case 8:
            res = "‚òÄÔ∏è Buenos d√≠as, espero que tu d√≠a sea excelente. ‚òÄÔ∏è";
            break;
        case 9:
            res = "‚òÄÔ∏è ¬°Hola! Que tengas una muy buena ma√±ana. ‚òÄÔ∏è";
            break;
        case 10:
            res = "‚òÄÔ∏è Buenos d√≠as, sigue adelante con tus objetivos. ‚òÄÔ∏è";
            break;
        case 11:
            res = "üåû ¬°Ya casi mediod√≠a! Espero que todo est√© bien. üåû";
            break;
        case 12:
            res = "üïõ Es mediod√≠a, hora de un descanso merecido. üïõ";
            break;
        case 13:
            res = "üåû Buenas tardes, espero que hayas almorzado bien. üåû";
            break;
        case 14:
            res = "üåû Buenas tardes, ¬°a seguir con energ√≠a! üåû";
            break;
        case 15:
            res = "üåÖ Buenas tardes, espero que est√©s cumpliendo tus metas. üåÖ";
            break;
        case 16:
            res = "üåÖ Buenas tardes, a√∫n queda mucho por hacer. üåÖ";
            break;
        case 17:
            res = "üåÖ Buenas tardes, el d√≠a est√° terminando. üåÖ";
            break;
        case 18:
            res = "üåá Buenas tardes, el sol se est√° poniendo. üåá";
            break;
        case 19:
            res = "üåô Buenas noches, espero que hayas tenido un buen d√≠a. üåô";
            break;
        case 20:
            res = "üåô Buenas noches, es hora de relajarse. üåô";
            break;
        case 21:
            res = "üåô Buenas noches, descansa para tener un gran d√≠a ma√±ana. üåô";
            break;
        case 22:
            res = "üåô Ya es tarde, ¬°hora de descansar! üåô";
            break;
        case 23:
            res = "üåô Casi medianoche, que tengas un buen descanso. üåô";
            break;
        default:
            res = "üåô Espero que descanses bien. üåô";
    }

    return res;
}

function pickRandom(list) {
    return list[Math.floor(list.length * Math.random())];
}

