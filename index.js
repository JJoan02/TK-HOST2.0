//     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
//     â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
//        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   
//        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
//        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
//        â•šâ•â•   â•šâ•â•  â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•   â•šâ•â•   

//       ____ ____  _____    _    ____   ___    ____   ___  ____  
//      / ___|  _ \| ____|  / \  |  _ \ / _ \  |  _ \ / _ \|  _ \ 
//     | |   | |_) |  _|   / _ \ | | | | | | | | |_) | | | | |_) |
//     | |___|  _ <| |___ / ___ \| |_| | |_| | |  __/| |_| |  _ < 
//      \____|_| \_\_____/_/   \_\____/ \___/  |_|    \___/|_| \_\


//          â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
//          â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘    â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•
//          â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• 
//     â–ˆâ–ˆ   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— 
//     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—
//      â•šâ•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•       â•šâ•â•   â•šâ•â•  â•šâ•â•
                                                        
/*
        ğŸ“ ğ—£ğ—¿ğ—¼ğ—·ğ—²ğ—°ğ˜ ğ—¡ğ—®ğ—ºğ—²: TK-HOST
        ğŸ™ ğ—šğ—¶ğ˜ğ—µğ˜‚ğ—¯ ğ—¥ğ—²ğ—½ğ—¼ğ˜€ğ—¶ğ˜ğ—¼ğ—¿ğ˜†: [JJoan02/TK-HOST](https://github.com/JJoan02/TK-HOST)
        ğŸ‘¤ ğ—¢ğ˜„ğ—»ğ—²ğ—¿/ğ—–ğ—¿ğ—²ğ—®ğ˜ğ—¼ğ—¿: @JJoan02
        ğŸ“Œ ğ——ğ—²ğ˜€ğ—°ğ—¿ğ—¶ğ—½ğ˜ğ—¶ğ—¼ğ—»:
        TK-HOST es un bot avanzado y multifuncional para WhatsApp que ofrece una amplia gama de complementos, 
        incluyendo automatizaciÃ³n de tareas, juegos interactivos, y herramientas Ãºtiles. 
        Con un diseÃ±o centrado en la eficiencia y el entretenimiento, TK-HOST transforma la forma en que interactÃºas 
        en WhatsApp, brindÃ¡ndote una experiencia intuitiva y poderosa.

        
        ğŸ“… ğ—–ğ—¿ğ—²ğ—®ğ˜ğ—¶ğ—¼ğ—»: 15/11/2024 at 08:25:10
        ğŸ“œ ğ—Ÿğ—¶ğ—°ğ—²ğ—»ğ—°ğ—²: GPL-3.0 License
        âš ï¸ ğ—¥ğ—¶ğ—´ğ—µğ˜ğ˜€ ğ—¡ğ—¼ğ˜ğ—¶ğ—°ğ—²:
        2024 All external and internal rights are reserved to @JJoan02.
*/                                                            

//         â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
//         â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•—
//         â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
//    â–ˆâ–ˆ   â–ˆâ–ˆâ•‘â–ˆâ–ˆ   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• 
//    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
//     â•šâ•â•â•â•â•  â•šâ•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•


import yargs from 'yargs';
import { hideBin } from 'yargs/helpers';
import cfonts from 'cfonts';
import { fileURLToPath } from 'url';
import { join, dirname } from 'path';
import { createRequire } from 'module';
import { createInterface } from 'readline';
import { setupMaster, fork } from 'cluster';
import { watchFile, unwatchFile } from 'fs';
import { openDb } from './data/codigos.js';
import cron from 'node-cron';

// Paths and Module Setup
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const require = createRequire(import.meta.url);

const { name, author } = require(join(__dirname, './package.json'));

const rl = createInterface({
  input: process.stdin,
  output: process.stdout
});

let isProcessRunning = false;

// Display Application Banner
function displayBanner() {
  const banners = [
    { text: 'TK-HOST', font: 'block', align: 'center', colors: ['cyan'] },
    { text: 'TK-HOST', font: 'console', align: 'center', colors: ['red'] },
    { text: 'Created by â€¢ JoanTK', font: 'tiny', align: 'center', colors: ['magenta'] }
  ];

  banners.forEach(banner => {
    cfonts.say(banner.text, {
      font: banner.font,
      align: banner.align,
      colors: banner.colors
    });
  });

  console.log('âœ¦ Starting TK-HOST...');
}

// Initialize Database
async function initializeDatabase() {
  try {
    const db = await openDb();
    await db.exec(`
      CREATE TABLE IF NOT EXISTS codigos (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        codigo TEXT UNIQUE,
        usuario TEXT,
        creadoEn TEXT,
        expiraEn TEXT,
        expirado INTEGER
      );

      CREATE TABLE IF NOT EXISTS vinculaciones (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        codigoVinculacion TEXT UNIQUE,
        usuario TEXT,
        creadoEn TEXT,
        expiraEn TEXT,
        utilizado INTEGER DEFAULT 0
      );

      CREATE TABLE IF NOT EXISTS sesiones (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        usuario TEXT UNIQUE,
        inicio TEXT,
        fin TEXT
      );
    `);
    console.log('Database initialized and tables created.');
  } catch (error) {
    console.error('Error initializing the database:', error);
  }
}

// Configure Scheduled Tasks
function configureScheduledTasks() {
  cron.schedule('0 0 * * *', async () => {
    try {
      const db = await openDb();
      const currentDateTime = new Date().toISOString();

      await db.run('UPDATE codigos SET expirado = 1 WHERE expiraEn <= ?', [currentDateTime]);
      await db.run('UPDATE vinculaciones SET utilizado = 1 WHERE expiraEn <= ?', [currentDateTime]);

      console.log('Scheduled task executed: Expired codes cleaned.');
    } catch (error) {
      console.error('Error executing scheduled task:', error);
    }
  });

  console.log('Scheduled tasks configured.');
}

// Start Application
function startApp(entryFile) {
  if (isProcessRunning) return;
  isProcessRunning = true;

  const args = [join(__dirname, entryFile), ...process.argv.slice(2)];
  console.log('Starting main file:', entryFile);

  setupMaster({
    exec: args[0],
    args: args.slice(1)
  });

  const worker = fork();

  worker.on('message', message => {
    console.log('[âœ… RECEIVED]', message);
    switch (message) {
      case 'reset':
        worker.kill();
        isProcessRunning = false;
        startApp(entryFile);
        break;
      case 'uptime':
        worker.send(process.uptime());
        break;
      default:
        console.log('Unknown message received:', message);
    }
  });

  worker.on('exit', code => {
    isProcessRunning = false;
    console.error('[âœ¦] Process exited with code:', code);

    if (code !== 0) {
      startApp(entryFile);
    } else {
      watchFile(args[0], () => {
        unwatchFile(args[0]);
        startApp(entryFile);
      });
    }
  });

  if (!rl.listenerCount('line')) {
    rl.on('line', input => {
      worker.emit('message', input.trim());
    });
  }
}

// Main Execution
(async () => {
  displayBanner();
  await initializeDatabase();
  configureScheduledTasks();
  startApp('main.js');
  console.log('Escribe el nÃºmero de WhatsApp a vincular:');
})();
